<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–¢—é—Ä—è–≥–∞: –ë—Ä–∞—Ç–≤–∞ –≤ —Å–±–æ—Ä–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --gold: #f0c571;
            --brown: #2d1a12;
            --orange: #d35400;
            --red: #ff4444;
            --blue: #3498db;
        }

        body {
            background: #1a0f0a url('https://www.transparenttextures.com/patterns/dark-brick-wall.png');
            color: #fff; font-family: 'Arial Narrow', sans-serif;
            margin: 0; padding: 0; overflow: hidden; user-select: none;
        }

        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ */
        #setup-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .char-card {
            width: 140px; height: 200px; margin: 10px; border: 2px solid #333;
            background-size: cover; border-radius: 10px; transition: 0.3s;
        }
        .char-card.selected { border-color: var(--gold); box-shadow: 0 0 20px var(--gold); transform: scale(1.05); }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header {
            display: grid; grid-template-columns: repeat(4, 1fr);
            background: linear-gradient(to bottom, #4a2b1d, #2d1a12);
            border-bottom: 2px solid #5e3a29; height: 60px; text-align: center;
        }
        .header div { border-right: 1px solid #5e3a29; display: flex; flex-direction: column; justify-content: center; font-size: 11px; }
        .header b { color: var(--gold); font-size: 14px; }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        .main-stage { position: relative; height: calc(100vh - 60px); width: 100%; }
        
        /* –ë–æ—Å—Å */
        .boss-area {
            position: absolute; top: 10px; right: 10px; width: 150px;
            background: rgba(0,0,0,0.6); padding: 8px; border-radius: 8px; border: 1px solid #5e3a29;
        }
        .boss-img { width: 50px; height: 50px; float: left; margin-right: 8px; border-radius: 4px; }

        /* –ü–µ—Ä—Å–æ–Ω–∞–∂ */
        .hero-body {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 75vh; background-size: contain; background-repeat: no-repeat;
            background-position: center bottom; z-index: 1;
        }
        .rage-active { animation: shake 0.1s infinite; filter: sepia(0.5) saturate(4) hue-rotate(-30deg); }

        /* –ú–µ–Ω—é */
        .side-nav {
            position: absolute; left: 10px; top: 10px; display: flex; flex-direction: column; gap: 10px; z-index: 10;
        }
        .nav-btn {
            width: 50px; height: 50px; background: #3d2419; border: 2px solid #5e3a29;
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
        .bar { width: 100%; height: 8px; background: #000; border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .fill { height: 100%; transition: width 0.3s; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .action-zone { position: absolute; bottom: 20px; width: 100%; text-align: center; z-index: 20; }
        .btn-main {
            background: linear-gradient(to bottom, var(--orange), #a04000);
            border: 1px solid var(--gold); color: #fff; padding: 15px 50px;
            font-size: 22px; font-weight: bold; border-radius: 8px; box-shadow: 0 4px 0 #5e2700;
        }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #5e2700; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen {
            display: none; position: fixed; top: 60px; bottom: 0; width: 100%;
            background: rgba(20,10,5,0.98); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto;
        }
        .screen.active { display: block; }
        .card { background: #2d1a12; border: 1px solid #5e3a29; padding: 15px; margin-bottom: 10px; border-radius: 6px; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) translateX(-50%); }
            50% { transform: translate(-1px, -2px) translateX(-50%); }
            100% { transform: translate(1px, 2px) translateX(-50%); }
        }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--gold)">–ö–¢–û –¢–´ –ü–û –ñ–ò–ó–ù–ò?</h1>
    <div style="display:flex">
        <div class="char-card" id="c1" onclick="game.pick(1)" style="background-image:url('https://i.imgur.com/39A0vW3.png')"></div>
        <div class="char-card" id="c2" onclick="game.pick(2)" style="background-image:url('https://i.imgur.com/8pS1S0V.png')"></div>
    </div>
    <button class="btn-main" onclick="game.start()" style="margin-top:20px">–í –•–ê–¢–£</button>
</div>

<div class="header">
    <div>‚ö° –≠–ù–ï–†–ì–ò–Ø<b id="st-en">0/0</b></div>
    <div>ü§ò –°–ò–õ–ê<b id="st-pwr">0</b></div>
    <div>üö¨ –ü–ê–ü–ò–†–û–°–´<b id="st-cigs">0</b></div>
    <div>üåü –£–†–û–í–ï–ù–¨<b id="st-lvl">1</b></div>
</div>

<div class="main-stage">
    <div class="side-nav">
        <div class="nav-btn" onclick="game.scr('main')">üè†</div>
        <div class="nav-btn" onclick="game.scr('quests')">üìú</div>
        <div class="nav-btn" onclick="game.scr('shop')">üõí</div>
        <div class="nav-btn" onclick="game.scr('ink')">üíâ</div>
    </div>

    <div class="boss-area">
        <img id="b-img" class="boss-img" src="">
        <div style="font-size:12px"><b id="b-name"></b></div>
        <div class="bar"><div id="hp-fill" class="fill" style="background:var(--red)"></div></div>
        <small id="hp-txt" style="font-size:10px"></small>
    </div>

    <div id="hero" class="hero-body"></div>

    <div class="action-zone">
        <div id="rage-box" style="width:120px; margin:0 auto 5px auto">
            <div class="bar" style="height:4px"><div id="rage-fill" class="fill" style="background:var(--gold)"></div></div>
        </div>
        <button id="hit-btn" class="btn-main" onclick="game.hit()">–ß–Å –ù–ê? (-1‚ö°)</button>
    </div>
</div>

<div id="scr-quests" class="screen">
    <h2 style="color:var(--gold)">–î–ï–õ–ê –í –¢–Æ–†–¨–ú–ï</h2>
    <div id="q-list"></div>
</div>

<div id="scr-shop" class="screen">
    <h2 style="color:var(--gold)">–õ–ê–í–ö–ê</h2>
    <div class="card">
        <b>–ß–∏—Ñ–∏—Ä–±–∞–∫</b><p>–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ +30 —ç–Ω–µ—Ä–≥–∏–∏</p>
        <button class="btn-main" style="padding:10px; font-size:14px" onclick="game.buy('en')">50 üö¨</button>
    </div>
    <div class="card">
        <b>–ì–∞–Ω—Ç–µ–ª–∏</b><p>–ü–æ–≤—ã—à–∞—é—Ç —Å–∏–ª—É ü§ò –Ω–∞ +5</p>
        <button class="btn-main" style="padding:10px; font-size:14px" onclick="game.buy('pwr')">500 üö¨</button>
    </div>
</div>

<div id="scr-ink" class="screen">
    <h2 style="color:var(--gold)">–ö–û–õ–¨–©–ò–ö</h2>
    <div id="i-list"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

class PrisonGame {
    constructor() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const save = JSON.parse(localStorage.getItem('prison_save')) || {};
        this.cigs = save.cigs || 500;
        this.pwr = save.pwr || 10;
        this.en = save.en || 30;
        this.maxEn = 30;
        this.lvl = save.lvl || 1;
        this.exp = save.exp || 0;
        this.myChar = save.myChar || '';
        this.myTattoos = save.myTattoos || [];
        
        this.rage = 0;
        this.isRage = false;

        this.bosses = [
            { n: "–ö–∏—Ä–ø–∏—á", hp: 1000, m: 1000, rew: 200, img: 'https://i.imgur.com/8pS1S0V.png' },
            { n: "–°–∏–∑—ã–π", hp: 5000, m: 5000, rew: 1000, img: 'https://i.imgur.com/8pS1S0V.png' },
            { n: "–ú–∞—Ö–Ω–æ", hp: 20000, m: 20000, rew: 4000, img: 'https://i.imgur.com/8pS1S0V.png' },
            { n: "–®–∞–π–±–∞", hp: 100000, m: 100000, rew: 15000, img: 'https://i.imgur.com/8pS1S0V.png' }
        ];
        this.bIdx = save.bIdx || 0;

        this.tattoos = [
            { id: 't1', n: "–ü–µ—Ä—Å—Ç–µ–Ω—å", cost: 1000, dmg: 20 },
            { id: 't2', n: "–ó–≤–µ–∑–¥—ã", cost: 5000, dmg: 100 },
            { id: 't3', n: "–ö—É–ø–æ–ª–∞", cost: 20000, dmg: 500 }
        ];

        this.quests = [
            { n: "–®–º–æ–Ω –≤ –∫–∞–º–µ—Ä–µ", en: 5, rew: 150, exp: 20 },
            { n: "–†–∞–∑–±–æ—Ä–∫–∞ –≤ —Å—Ç–æ–ª–æ–≤–æ–π", en: 15, rew: 500, exp: 100 }
        ];

        if(this.myChar) {
            document.getElementById('setup-screen').style.display = 'none';
            this.setHeroImg();
        }
        
        this.update();
        setInterval(() => this.regen(), 5000);
    }

    save() {
        const data = { cigs: this.cigs, pwr: this.pwr, en: this.en, lvl: this.lvl, exp: this.exp, myChar: this.myChar, myTattoos: this.myTattoos, bIdx: this.bIdx };
        localStorage.setItem('prison_save', JSON.stringify(data));
    }

    pick(id) {
        this.myChar = id === 1 ? 'https://i.imgur.com/39A0vW3.png' : 'https://i.imgur.com/8pS1S0V.png';
        document.querySelectorAll('.char-card').forEach((c, i) => c.classList.toggle('selected', i === id-1));
    }

    start() {
        if(!this.myChar) return tg.showAlert("–í—ã–±–µ—Ä–∏ –ª–∏—Ü–æ, –∞—Ä–µ—Å—Ç–∞–Ω—Ç!");
        document.getElementById('setup-screen').style.display = 'none';
        this.setHeroImg();
        this.save();
    }

    setHeroImg() { document.getElementById('hero').style.backgroundImage = `url(${this.myChar})`; }

    scr(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        if(id !== 'main') document.getElementById('scr-' + id).classList.add('active');
        if(id === 'quests') this.renderQuests();
        if(id === 'ink') this.renderInk();
    }

    hit() {
        if(this.en <= 0) return tg.showAlert("–°–∏–ª –Ω–µ—Ç. –•–ª–µ–±–Ω–∏ —á–∏—Ñ–∏—Ä–∫—É!");
        this.en--;
        
        let dmg = this.pwr;
        this.myTattoos.forEach(tid => {
            const t = this.tattoos.find(x => x.id === tid);
            if(t) dmg += t.dmg;
        });

        if(this.isRage) dmg *= 5;
        else { this.rage += 5; if(this.rage >= 100) this.startRage(); }

        this.bosses[this.bIdx].hp -= dmg;
        this.exp += 5;
        tg.HapticFeedback.impactOccurred(this.isRage ? 'heavy' : 'light');

        if(this.bosses[this.bIdx].hp <= 0) this.winBoss();
        this.checkLvl();
        this.update();
        this.save();
    }

    startRage() {
        this.isRage = true; this.rage = 100;
        document.getElementById('hero').classList.add('rage-active');
        setTimeout(() => {
            this.isRage = false; this.rage = 0;
            document.getElementById('hero').classList.remove('rage-active');
            this.update();
        }, 5000);
    }

    winBoss() {
        const b = this.bosses[this.bIdx];
        this.cigs += b.rew;
        this.exp += b.rew / 2;
        tg.showAlert(`–ë–æ—Å—Å ${b.n} –ø–æ–≤–µ—Ä–∂–µ–Ω! –ü–æ–ª—É—á–µ–Ω–æ ${b.rew} üö¨`);
        this.bIdx = (this.bIdx + 1) % this.bosses.length;
        this.bosses[this.bIdx].hp = this.bosses[this.bIdx].m;
    }

    checkLvl() {
        let need = this.lvl * 500;
        if(this.exp >= need) {
            this.lvl++; this.exp = 0;
            this.maxEn += 5; this.en = this.maxEn;
            tg.showAlert(`–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${this.lvl}! –≠–Ω–µ—Ä–≥–∏—è –ø–æ–≤—ã—à–µ–Ω–∞.`);
        }
    }

    buy(type) {
        if(type === 'en' && this.cigs >= 50) { this.cigs -= 50; this.en = this.maxEn; }
        if(type === 'pwr' && this.cigs >= 500) { this.cigs -= 500; this.pwr += 5; }
        this.update(); this.save();
    }

    renderQuests() {
        document.getElementById('q-list').innerHTML = this.quests.map(q => `
            <div class="card">
                <b>${q.n}</b><p>–ù–∞–≥—Ä–∞–¥–∞: ${q.rew} üö¨ | +${q.exp}üåü</p>
                <button class="btn-main" style="padding:10px; font-size:14px" onclick="game.doQuest('${q.n}')">-${q.en} ‚ö°</button>
            </div>
        `).join('');
    }

    doQuest(name) {
        const q = this.quests.find(x => x.n === name);
        if(this.en >= q.en) {
            this.en -= q.en; this.cigs += q.rew; this.exp += q.exp;
            this.checkLvl(); this.update(); this.renderQuests(); this.save();
        } else tg.showAlert("–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏!");
    }

    renderInk() {
        document.getElementById('i-list').innerHTML = this.tattoos.map(t => `
            <div class="card">
                <b>${t.n}</b><p>–£—Ä–æ–Ω: +${t.dmg} ü§ò</p>
                <button class="btn-main" style="padding:10px; font-size:14px" onclick="game.buyInk('${t.id}', ${t.cost})" 
                ${this.myTattoos.includes(t.id)?'disabled':''}>${t.cost} üö¨</button>
            </div>
        `).join('');
    }

    buyInk(id, cost) {
        if(this.cigs >= cost) {
            this.cigs -= cost; this.myTattoos.push(id);
            this.update(); this.renderInk(); this.save();
        }
    }

    regen() { if(this.en < this.maxEn) { this.en++; this.update(); } }

    update() {
        document.getElementById('st-en').innerText = `${this.en}/${this.maxEn}`;
        document.getElementById('st-pwr').innerText = this.pwr;
        document.getElementById('st-cigs').innerText = Math.floor(this.cigs);
        document.getElementById('st-lvl').innerText = this.lvl;
        
        const b = this.bosses[this.bIdx];
        document.getElementById('b-name').innerText = b.n;
        document.getElementById('b-img').src = b.img;
        document.getElementById('hp-fill').style.width = (b.hp/b.m*100)+'%';
        document.getElementById('hp-txt').innerText = `${Math.ceil(b.hp)}/${b.m} HP`;
        document.getElementById('rage-fill').style.width = this.rage + '%';
        document.getElementById('hit-btn').disabled = (this.en <= 0);
    }
}
const game = new PrisonGame();
</script>
</body>
</html>
