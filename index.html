<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–¢—é—Ä—è–≥–∞: –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --gold: #f0c571;
            --dark-brown: #2d1a12;
            --prison-orange: #d35400;
            --rage-color: #ff0000;
        }

        body {
            background: #1a0f0a url('https://www.transparenttextures.com/patterns/dark-brick-wall.png');
            color: #fff;
            font-family: 'Arial Narrow', sans-serif;
            margin: 0; padding: 0; overflow: hidden; user-select: none;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-nav {
            display: flex;
            background: linear-gradient(to bottom, #4a2b1d, #2d1a12);
            border-bottom: 2px solid #5e3a29;
            height: 45px;
            align-items: center;
            font-size: 13px;
            box-shadow: 0 2px 10px #000;
        }

        .top-nav div {
            flex: 1;
            text-align: center;
            border-right: 1px solid #5e3a29;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
        .game-area {
            position: relative;
            height: calc(100vh - 45px);
            width: 100%;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        .character-box {
            position: relative;
            width: 100%;
            height: 60vh;
            background: url('https://i.imgur.com/39A0vW3.png') no-repeat center bottom;
            background-size: contain;
            transition: transform 0.05s;
            z-index: 1;
        }

        /* –°–ª–æ–∏ —Ç–∞—Ç—É–∏—Ä–æ–≤–æ–∫ */
        .tattoo-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        .tattoo-layer.visible { opacity: 1; }

        /* –≠—Ñ—Ñ–µ–∫—Ç –Ø—Ä–æ—Å—Ç–∏ */
        .rage-mode .character-box { 
            animation: shake 0.1s infinite; 
            filter: sepia(0.5) saturate(3) hue-rotate(-30deg) drop-shadow(0 0 15px red); 
        }

        @keyframes shake {
            0% { transform: translate(2px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, -2px) rotate(-1deg); }
            100% { transform: translate(1px, 2px) rotate(0deg); }
        }

        /* –ë–æ—Å—Å */
        .boss-ui {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px;
            text-align: right;
            z-index: 5;
        }

        .hp-bar {
            background: #111;
            border: 1px solid #444;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 5px;
        }

        .hp-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #ff4444, #990000);
            transition: width 0.2s;
        }

        /* –®–∫–∞–ª–∞ —è—Ä–æ—Å—Ç–∏ */
        .rage-ui {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            text-align: center;
            z-index: 5;
        }

        .rage-bar {
            background: rgba(0,0,0,0.5);
            border: 1px solid #555;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        #rage-fill {
            width: 0%;
            height: 100%;
            background: var(--rage-color);
            box-shadow: 0 0 10px var(--rage-color);
        }

        /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */
        .side-menu {
            position: absolute;
            left: 15px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
        }

        .icon-btn {
            width: 48px;
            height: 48px;
            background: #3d2419;
            border: 2px solid #5e3a29;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: inset 0 0 10px #000;
        }

        /* –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è */
        .footer {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
        }

        .btn-hit {
            background: linear-gradient(to bottom, #d35400, #a04000);
            border: 1px solid #f39c12;
            color: #fff;
            padding: 15px 50px;
            font-weight: bold;
            font-size: 22px;
            border-radius: 6px;
            text-shadow: 1px 1px #000;
            box-shadow: 0 5px 0 #5e2700;
        }

        .btn-hit:active { transform: translateY(3px); box-shadow: 0 2px 0 #5e2700; }
        .btn-hit.rage { background: #ff0000; border-color: #fff; animation: pulse 0.5s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen {
            display: none;
            position: fixed;
            top: 45px; bottom: 0; width: 100%;
            background: rgba(20,10,5,0.98);
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
        }
        .screen.active { display: block; }

        .list-item {
            background: #2d1a12;
            border: 1px solid #5e3a29;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }
    </style>
</head>
<body id="game-body">

<div class="top-nav">
    <div style="color: var(--gold)">üë§ <span id="st-rank">–®–ù–´–†–¨</span></div>
    <div style="color: #2ecc71">üö¨ <span id="st-cigs">0</span></div>
    <div style="color: var(--gold)">ü¶∑ <span id="st-teeth">0</span></div>
</div>

<div class="game-area">
    <div class="side-menu">
        <div class="icon-btn" onclick="game.scr('main')">üè†</div>
        <div class="icon-btn" onclick="game.scr('ink')">üíâ</div>
    </div>

    <div class="boss-ui">
        <b id="b-name" style="color: var(--gold); text-transform: uppercase;">–ö–ò–†–ü–ò–ß</b>
        <div class="hp-bar"><div id="hp-fill" class="hp-fill"></div></div>
        <small id="hp-num" style="color: #aaa; font-size: 11px;">1000/1000</small>
    </div>

    <div class="character-box" id="char-box">
        <div id="layer-stars" class="tattoo-layer" style="background-image: url('https://i.imgur.com/stars_placeholder.png');"></div>
        <div id="layer-ring" class="tattoo-layer" style="background-image: url('https://i.imgur.com/ring_placeholder.png');"></div>
        <div id="layer-domes" class="tattoo-layer" style="background-image: url('https://i.imgur.com/domes_placeholder.png');"></div>
    </div>

    <div class="rage-ui">
        <small id="rage-status" style="color: #666; font-weight: bold;">–Ø–†–û–°–¢–¨</small>
        <div class="rage-bar"><div id="rage-fill"></div></div>
    </div>

    <div class="footer">
        <button id="hit-btn" class="btn-hit" onclick="game.hit()">–ß–Å –ù–ê?</button>
    </div>
</div>

<div id="scr-ink" class="screen">
    <h2 style="color: var(--gold); border-bottom: 2px solid #5e3a29; padding-bottom: 10px;">–°–ê–õ–û–ù –ö–û–õ–¨–©–ò–ö–ê</h2>
    <div id="ink-list"></div>
    <button class="btn-hit" style="width:100%; margin-top:20px;" onclick="game.scr('main')">–ù–ê–ó–ê–î</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

class PrisonGame {
    constructor() {
        this.cigs = 500;
        this.teeth = 0;
        this.myTattoos = [];
        
        // –ú–µ—Ö–∞–Ω–∏–∫–∞ —è—Ä–æ—Å—Ç–∏
        this.rage = 0;
        this.isRageMode = false;

        // –î–∞–Ω–Ω—ã–µ –±–æ—Å—Å–æ–≤ (–ø–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ)
        this.bosses = [
            { id: 0, n: "–ö–∏—Ä–ø–∏—á", hp: 1000, m: 1000, rew: 200 },
            { id: 1, n: "–°–∏–∑—ã–π", hp: 10000, m: 10000, rew: 1000 },
            { id: 2, n: "–ú–∞—Ö–Ω–æ", hp: 50000, m: 50000, rew: 5000 },
            { id: 3, n: "–õ—é—Ç—ã–π", hp: 100000, m: 100000, rew: 15000 },
            { id: 4, n: "–®–∞–π–±–∞", hp: 500000, m: 500000, rew: 50000 }
        ];
        this.bIdx = 0;

        // –ú–∞–≥–∞–∑–∏–Ω —Ç–∞—Ç—É–∏—Ä–æ–≤–æ–∫
        this.tattoos = [
            { id: 'stars', n: "–í–æ—Ä–æ–≤—Å–∫–∏–µ –∑–≤–µ–∑–¥—ã", cost: 1000, dmg: 40 },
            { id: 'ring', n: "–ü–µ—Ä—Å—Ç–µ–Ω—å", cost: 5000, dmg: 120 },
            { id: 'domes', n: "–ö—É–ø–æ–ª–∞", cost: 25000, dmg: 500 }
        ];

        this.update();
        setInterval(() => this.decayRage(), 300); // –Ø—Ä–æ—Å—Ç—å –ø–æ—Ç–∏—Ö–æ–Ω—å–∫—É –ø–∞–¥–∞–µ—Ç
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
    scr(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        if(id === 'ink') {
            this.renderInk();
            document.getElementById('scr-ink').classList.add('active');
        }
    }

    // –õ–æ–≥–∏–∫–∞ —É–¥–∞—Ä–∞
    hit() {
        let baseDmg = 15;
        // –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–Ω –æ—Ç –≤—Å–µ—Ö –Ω–∞–±–∏—Ç—ã—Ö —Ç–∞—Ç—É
        this.myTattoos.forEach(tid => {
            const t = this.tattoos.find(x => x.id === tid);
            if(t) baseDmg += t.dmg;
        });

        const multiplier = this.isRageMode ? 5 : 1;
        const finalDmg = baseDmg * multiplier;

        this.bosses[this.bIdx].hp -= finalDmg;

        // –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —è—Ä–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —è—Ä–æ—Å—Ç–∏)
        if(!this.isRageMode) {
            this.rage += 4;
            if(this.rage >= 100) this.activateRage();
        }

        // –≠—Ñ—Ñ–µ–∫—Ç—ã
        tg.HapticFeedback.impactOccurred(this.isRageMode ? 'heavy' : 'light');

        if(this.bosses[this.bIdx].hp <= 0) this.winBoss();
        this.update();
    }

    activateRage() {
        this.isRageMode = true;
        this.rage = 100;
        document.getElementById('game-body').classList.add('rage-mode');
        document.getElementById('hit-btn').classList.add('rage');
        document.getElementById('rage-status').innerText = "–ü–û–®–õ–ê –ñ–ê–†–ê!!!";
        document.getElementById('rage-status').style.color = "red";

        setTimeout(() => {
            this.isRageMode = false;
            this.rage = 0;
            document.getElementById('game-body').classList.remove('rage-mode');
            document.getElementById('hit-btn').classList.remove('rage');
            document.getElementById('rage-status').innerText = "–Ø–†–û–°–¢–¨";
            document.getElementById('rage-status').style.color = "#666";
            this.update();
        }, 5000); // –Ø—Ä–æ—Å—Ç—å –¥–ª–∏—Ç—Å—è 5 —Å–µ–∫—É–Ω–¥
    }

    decayRage() {
        if(!this.isRageMode && this.rage > 0) {
            this.rage -= 2;
            this.update();
        }
    }

    winBoss() {
        const b = this.bosses[this.bIdx];
        this.cigs += b.rew;
        this.teeth += (this.bIdx + 1);
        tg.showAlert(`–ë–æ—Å—Å ${b.n} –ø–æ–≤–µ—Ä–∂–µ–Ω! –ü–æ–ª—É—á–µ–Ω–æ: ${b.rew} –ø–∞–ø–∏—Ä–æ—Å –∏ ${this.bIdx + 1} –∑—É–±(–∞).`);
        
        if(this.bIdx < this.bosses.length - 1) {
            this.bIdx++;
        } else {
            this.bIdx = 0; // –°–±—Ä–æ—Å –Ω–∞ –ø–µ—Ä–≤—ã–π –∫—Ä—É–≥
            tg.showAlert("–¢—ã –∑–∞–≤–∞–ª–∏–ª –≤—Å–µ—Ö! –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç!");
        }
        this.bosses[this.bIdx].hp = this.bosses[this.bIdx].m;
    }

    renderInk() {
        const list = document.getElementById('ink-list');
        list.innerHTML = this.tattoos.map(t => `
            <div class="list-item">
                <div>
                    <b style="color:var(--gold)">${t.n}</b><br>
                    <small>+${t.dmg} –∫ —É—Ä–æ–Ω—É</small>
                </div>
                <button class="btn-hit" style="font-size:14px; padding:8px 15px;" 
                    onclick="game.buyInk('${t.id}', ${t.cost})"
                    ${this.myTattoos.includes(t.id) ? 'disabled' : ''}>
                    ${this.myTattoos.includes(t.id) ? '–ù–ê–ë–ò–¢–û' : t.cost + ' üö¨'}
                </button>
            </div>
        `).join('');
    }

    buyInk(id, cost) {
        if(this.cigs >= cost) {
            this.cigs -= cost;
            this.myTattoos.push(id);
            tg.HapticFeedback.notificationOccurred('success');
            this.renderInk();
            this.update();
        } else {
            tg.showAlert("–ü–∞–ø–∏—Ä–æ—Å –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, —à–Ω—ã—Ä—å!");
        }
    }

    update() {
        const b = this.bosses[this.bIdx];
        // –¢–µ–∫—Å—Ç
        document.getElementById('st-cigs').innerText = Math.floor(this.cigs);
        document.getElementById('st-teeth').innerText = this.teeth;
        document.getElementById('b-name').innerText = b.n;
        document.getElementById('hp-num').innerText = `${Math.ceil(b.hp)} / ${b.m}`;
        
        // –ü–æ–ª–æ—Å–∫–∏
        document.getElementById('hp-fill').style.width = (b.hp / b.m * 100) + '%';
        document.getElementById('rage-fill').style.width = this.rage + '%';

        // –†–∞–Ω–≥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑—É–±–æ–≤)
        const ranks = ["–®–ù–´–†–¨", "–ü–ê–¶–ê–ù", "–ú–£–ñ–ò–ö", "–ë–û–†–ó–´–ô", "–ê–í–¢–û–†–ò–¢–ï–¢"];
        let rIdx = Math.min(Math.floor(this.teeth / 5), ranks.length - 1);
        document.getElementById('st-rank').innerText = ranks[rIdx];

        // –ü—Ä–æ—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞—Ç—É –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ
        this.myTattoos.forEach(tid => {
            const el = document.getElementById('layer-' + tid);
            if(el) el.classList.add('visible');
        });
    }
}

// –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
const game = new PrisonGame();
</script>

</body>
</html>
