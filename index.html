<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–¢—é—Ä—è–≥–∞ TWA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* –ë–µ—Ä–µ–º —Ü–≤–µ—Ç–∞ –∏–∑ —Ç–µ–º—ã Telegram */
            --tg-bg: var(--tg-theme-bg-color, #1a1a1a);
            --tg-text: var(--tg-theme-text-color, #eee);
            --tg-btn: var(--tg-theme-button-color, #3390ec);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
        }
        body { 
            background: var(--tg-bg); 
            color: var(--tg-text); 
            font-family: sans-serif; 
            margin: 0; padding: 10px;
            display: flex; justify-content: center;
            overflow-x: hidden;
        }
        #game-container { width: 100%; max-width: 450px; }
        .boss-section { text-align: center; position: relative; margin-bottom: 15px; }
        .boss-img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid #d32f2f; transition: transform 0.1s; }
        
        .stats { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
        
        .btn { 
            background: var(--tg-btn); color: var(--tg-btn-text);
            border: none; padding: 15px; width: 100%; margin-bottom: 10px;
            border-radius: 12px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-attack { background: #d32f2f; color: white; }
        
        /* –ü–æ–ª–æ—Å–∫–∞ HP */
        .hp-bar-container { background: #333; height: 24px; border-radius: 12px; margin: 10px 0; position: relative; overflow: hidden; border: 1px solid #000; }
        #hp-fill { background: #f44336; height: 100%; width: 100%; transition: width 0.2s; }
        #hp-text { position: absolute; width: 100%; text-align: center; top: 3px; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 2px #000; }

        .log { background: rgba(0,0,0,0.3); height: 100px; overflow-y: auto; padding: 10px; font-size: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ —É—Ä–æ–Ω–∞ */
        .damage-popup { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: bold; color: #ff5252; animation: floatUp 0.6s forwards; z-index: 10; pointer-events: none; }
        @keyframes floatUp { 0% { opacity: 1; top: 40%; } 100% { opacity: 0; top: 20%; } }
        .shake { animation: shakeAnim 0.2s; }
        @keyframes shakeAnim { 0% { transform: translate(2px); } 50% { transform: translate(-2px); } 100% { transform: translate(0); } }
    </style>
</head>
<body>

<div id="game-container">
    <div class="boss-section">
        <img src="" id="boss-avatar" class="boss-img">
        <div id="boss-name" style="margin-top: 10px; font-weight: bold;"></div>
        <div class="hp-bar-container">
            <div id="hp-fill"></div>
            <div id="hp-text">0/0 HP</div>
        </div>
    </div>

    <div class="stats">
        <div class="stat-line"><span>–£—Ä–æ–≤–µ–Ω—å:</span> <span id="lvl">1</span></div>
        <div class="stat-line"><span>–ü–∞–ø–∏—Ä–æ—Å—ã:</span> <span id="cigs">0</span></div>
        <div class="stat-line"><span>–£—Ä–æ–Ω:</span> <span id="dmg">0</span></div>
        <div class="stat-line"><span>–≠–Ω–µ—Ä–≥–∏—è:</span> <span id="energy">0/0</span></div>
    </div>

    <button class="btn" onclick="game.doTask()">‚öíÔ∏è –°–¥–µ–ª–∞—Ç—å –¥–µ–ª–æ (-10‚ö°)</button>
    <button class="btn btn-attack" onclick="game.attackBoss()">üëä –£–¥–∞—Ä–∏—Ç—å –±–æ—Å—Å–∞</button>
    <button class="btn" style="background: #4a148c;" onclick="game.buyTattoo()">üíâ –ù–∞–∫–æ–ª–∫–∞ (-100 –ø–∞–ø–∏—Ä–æ—Å)</button>

    <div class="log" id="game-log"></div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

    class PrisonGame {
        constructor() {
            this.lvl = 1; this.auth = 0; this.cigs = 50; this.energy = 100; this.maxEnergy = 100; this.dmg = 10; this.currentBossIndex = 0;
            this.bossList = [
                { name: "–ö–∏—Ä–ø–∏—á", hp: 100, maxHp: 100, img: "https://i.imgur.com/6X2hSjI.png", minLvl: 1, reward: 200 },
                { name: "–°–∏–∑—ã–π", hp: 500, maxHp: 500, img: "https://i.imgur.com/8pS1S0V.png", minLvl: 3, reward: 1000 }
            ];
            this.loadGame();
            this.updateUI();
            setInterval(() => this.regenEnergy(), 5000);
        }

        get currentBoss() { return this.bossList[this.currentBossIndex]; }

        attackBoss() {
            const boss = this.currentBoss;
            if (boss.hp > 0) {
                // –í–∏–±—Ä–∞—Ü–∏—è Telegram!
                tg.HapticFeedback.impactOccurred('medium');
                
                const isCrit = Math.random() < 0.15;
                const d = isCrit ? this.dmg * 2 : this.dmg;
                boss.hp -= d;
                this.showDamage(d, isCrit);
                
                const img = document.getElementById('boss-avatar');
                img.classList.add('shake');
                setTimeout(() => img.classList.remove('shake'), 200);

                if (boss.hp <= 0) {
                    this.cigs += boss.reward;
                    this.log(`üèÜ ${boss.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!`);
                    this.currentBossIndex = (this.currentBossIndex + 1) % this.bossList.length;
                    this.currentBoss.hp = this.currentBoss.maxHp;
                }
                this.updateUI();
                this.saveGame();
            }
        }

        showDamage(amt, crit) {
            const p = document.createElement('div');
            p.className = 'damage-popup';
            if (crit) p.style.color = '#ffeb3b';
            p.innerText = (crit ? 'üî•' : '') + '-' + amt;
            document.querySelector('.boss-section').appendChild(p);
            setTimeout(() => p.remove(), 600);
        }

        doTask() {
            if (this.energy >= 10) {
                this.energy -= 10; this.cigs += 20; this.auth += 35;
                tg.HapticFeedback.notificationOccurred('success');
                this.checkLevelUp(); this.updateUI(); this.saveGame();
            }
        }

        checkLevelUp() {
            if (this.auth >= this.lvl * 100) {
                this.lvl++; this.maxEnergy += 20; this.energy = this.maxEnergy;
                this.log(`‚≠ê –£–†–û–í–ï–ù–¨ ${this.lvl}!`);
            }
        }

        updateUI() {
            document.getElementById('lvl').innerText = this.lvl;
            document.getElementById('cigs').innerText = this.cigs;
            document.getElementById('dmg').innerText = this.dmg;
            document.getElementById('energy').innerText = `${Math.floor(this.energy)}/${this.maxEnergy}`;
            const b = this.currentBoss;
            document.getElementById('boss-name').innerText = b.name;
            document.getElementById('boss-avatar').src = b.img;
            document.getElementById('hp-text').innerText = `${Math.max(0, b.hp)}/${b.maxHp} HP`;
            document.getElementById('hp-fill').style.width = `${(b.hp / b.maxHp) * 100}%`;
        }

        buyTattoo() {
            if (this.cigs >= 100) {
                this.cigs -= 100; this.dmg += 5;
                tg.HapticFeedback.impactOccurred('heavy');
                this.log("üíâ –ù–∞–±–∏—Ç–∞ –Ω–∞–∫–æ–ª–∫–∞! –£—Ä–æ–Ω +5");
                this.updateUI(); this.saveGame();
            }
        }

        log(m) {
            const l = document.getElementById('game-log');
            l.innerHTML += `<div>> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        regenEnergy() { if (this.energy < this.maxEnergy) { this.energy++; this.updateUI(); } }

        saveGame() {
            const data = { lvl: this.lvl, cigs: this.cigs, dmg: this.dmg, bossIdx: this.currentBossIndex, hp: this.currentBoss.hp, auth: this.auth };
            localStorage.setItem('tg_prison_save', JSON.stringify(data));
        }

        loadGame() {
            const s = localStorage.getItem('tg_prison_save');
            if (s) {
                const d = JSON.parse(s);
                this.lvl = d.lvl; this.cigs = d.cigs; this.dmg = d.dmg;
                this.currentBossIndex = d.bossIdx; this.bossList[this.currentBossIndex].hp = d.hp;
                this.auth = d.auth;
            }
        }
    }

    const game = new PrisonGame();
</script>
</body>
</html>