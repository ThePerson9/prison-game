<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–¢—é—Ä—è–≥–∞ TWA - Full Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #1a1a1a);
            --tg-text: var(--tg-theme-text-color, #eee);
            --tg-btn: var(--tg-theme-button-color, #3390ec);
            --tg-btn-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaa);
        }
        body { background: var(--tg-bg); color: var(--tg-text); font-family: sans-serif; margin: 0; padding: 15px; display: flex; justify-content: center; overflow-x: hidden; }
        #game-container { width: 100%; max-width: 450px; }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 15px; padding: 5px; border: 1px solid rgba(255,255,255,0.1); }
        .tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 10px; font-size: 14px; font-weight: bold; transition: 0.2s; }
        .tab-btn.active { background: var(--tg-btn); color: var(--tg-btn-text); }
        .game-screen { display: none; }
        .game-screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .user-profile { display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 15px; margin-bottom: 15px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--tg-btn); background: #333; }
        #user-name { font-weight: bold; font-size: 15px; }
        #user-status { font-size: 11px; color: var(--tg-btn); font-weight: bold; text-transform: uppercase; }

        /* –ë–æ—Å—Å */
        .boss-section { text-align: center; position: relative; margin-bottom: 15px; }
        .boss-img { width: 140px; height: 140px; border-radius: 50%; border: 4px solid #d32f2f; transition: transform 0.1s; box-shadow: 0 0 15px rgba(211, 47, 47, 0.3); }
        .hp-bar-container { background: #222; height: 20px; border-radius: 10px; margin: 10px 0; position: relative; overflow: hidden; border: 1px solid #000; }
        #hp-fill { background: linear-gradient(90deg, #ff5252, #b71c1c); height: 100%; width: 100%; transition: width 0.3s; }
        #hp-text { position: absolute; width: 100%; text-align: center; top: 2px; font-size: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }

        /* –°—Ç–∞—Ç—ã */
        .stats { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .stat-line { font-size: 13px; font-weight: bold; }
        .stat-line span:last-child { color: var(--tg-btn); }

        /* –ú–∞–≥–∞–∑–∏–Ω */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-item { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .shop-item.locked { opacity: 0.4; filter: grayscale(1); }
        .item-icon { font-size: 30px; margin-bottom: 5px; }
        .item-price { color: #ffeb3b; font-size: 12px; font-weight: bold; margin-top: 5px; }

        /* –ö–Ω–æ–ø–∫–∏ –∏ –õ–æ–≥ */
        .btn { background: var(--tg-btn); color: var(--tg-btn-text); border: none; padding: 14px; width: 100%; margin-bottom: 8px; border-radius: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-attack { background: #d32f2f; }
        .log { background: rgba(0,0,0,0.3); height: 70px; overflow-y: auto; padding: 8px; font-size: 11px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); color: var(--tg-hint); }

        .damage-popup { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: bold; color: #ff5252; animation: floatUp 0.5s forwards; pointer-events: none; text-shadow: 2px 2px 0 #000; }
        @keyframes floatUp { to { opacity: 0; transform: translate(-50%, -100%) scale(1.5); } }
        .shake { animation: shake 0.2s; }
        @keyframes shake { 0%, 100% { transform: translate(0); } 25% { transform: translate(-5px); } 75% { transform: translate(5px); } }
    </style>
</head>
<body>

<div id="game-container">
    <div class="tabs">
        <div id="btn-main" class="tab-btn active" onclick="game.showScreen('main')">üëä –ë–æ–π</div>
        <div id="btn-shop" class="tab-btn" onclick="game.showScreen('shop')">üõí –°–∫–ª–∞–¥</div>
        <div id="btn-top" class="tab-btn" onclick="game.showScreen('top')">üèÜ –¢–æ–ø</div>
    </div>

    <div id="screen-main" class="game-screen active">
        <div class="user-profile">
            <img src="" id="user-photo" class="user-avatar" style="display:none;">
            <div class="user-info">
                <div id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div id="user-status">–ü–µ—Ä–≤–æ—Ö–æ–¥</div>
            </div>
        </div>

        <div class="boss-section">
            <img src="" id="boss-avatar" class="boss-img">
            <div id="boss-name" style="margin-top: 8px; font-weight: bold;"></div>
            <div class="hp-bar-container">
                <div id="hp-fill"></div>
                <div id="hp-text">0/0 HP</div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-line">–£—Ä–æ–≤–µ–Ω—å: <span id="lvl">1</span></div>
            <div class="stat-line">–£—Ä–æ–Ω: <span id="dmg">10</span></div>
            <div class="stat-line">üö¨ –ü–∞–ø–∏—Ä–æ—Å—ã: <span id="cigs">0</span></div>
            <div class="stat-line">‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">0/0</span></div>
        </div>

        <button class="btn" onclick="game.doTask()">‚öíÔ∏è –°–¥–µ–ª–∞—Ç—å –¥–µ–ª–æ (-10‚ö°)</button>
        <button class="btn btn-attack" onclick="game.attackBoss()">üëä –£–¥–∞—Ä–∏—Ç—å –±–æ—Å—Å–∞</button>
        <button class="btn" style="background: #4a148c;" onclick="game.buyTattoo()">üíâ –ù–∞–∫–æ–ª–∫–∞ (-100 üö¨)</button>
        <div class="log" id="game-log"></div>
    </div>

    <div id="screen-shop" class="game-screen">
        <h3 style="margin: 0 0 15px 0; font-size: 16px;">–û—Ä—É–∂–µ–π–Ω—ã–π —Å–∫–ª–∞–¥</h3>
        <div id="shop-grid" class="shop-grid"></div>
    </div>

    <div id="screen-top" class="game-screen">
        <h3 style="margin: 0 0 15px 0; font-size: 16px;">–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç—ã –∑–æ–Ω—ã</h3>
        <div id="leaderboard">
            <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 13px;">
                –ü–æ–∫–∞ –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –ª–µ–≥–µ–Ω–¥—ã. –°—Ç–∞–Ω—å –ø–µ—Ä–≤—ã–º –≤ —Å–ø–∏—Å–∫–µ!
            </div>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    class PrisonGame {
        constructor() {
            this.lvl = 1; this.auth = 0; this.cigs = 50; this.energy = 100; this.maxEnergy = 100; this.dmg = 10;
            this.currentBossIndex = 0; this.ownedWeapons = [];
            
            this.bossList = [
                { name: "–ö–∏—Ä–ø–∏—á", hp: 100, maxHp: 100, img: "https://i.imgur.com/6X2hSjI.png", reward: 200 },
                { name: "–°–∏–∑—ã–π", hp: 600, maxHp: 600, img: "https://i.imgur.com/8pS1S0V.png", reward: 1200 },
                { name: "–ú–∞—Ö–Ω–æ", hp: 3000, maxHp: 3000, img: "https://i.imgur.com/BfR8A9k.png", reward: 5000 }
            ];

            this.weapons = [
                { id: 0, name: "–ó–∞—Ç–æ—á–∫–∞", dmg: 10, price: 300, lvl: 1, img: "üî™" },
                { id: 1, name: "–ö–∞—Å—Ç–µ—Ç", dmg: 30, price: 1500, lvl: 3, img: "ü•ä" },
                { id: 2, name: "–ê—Ä–º–∞—Ç—É—Ä–∞", dmg: 80, price: 5000, lvl: 6, img: "ü¶Ø" },
                { id: 3, name: "–û–±—Ä–µ–∑", dmg: 250, price: 15000, lvl: 10, img: "üî´" }
            ];

            this.loadGame();
            this.initTelegram();
            this.updateUI();
            setInterval(() => this.regenEnergy(), 5000);
        }

        initTelegram() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                document.getElementById('user-name').innerText = user.first_name;
                if (user.photo_url) {
                    const img = document.getElementById('user-photo');
                    img.src = user.photo_url; img.style.display = 'block';
                }
            } else { document.getElementById('user-name').innerText = "–ó–∞–∫–ª—é—á–µ–Ω–Ω—ã–π"; }
            this.updateStatus();
        }

        showScreen(id) {
            document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            tg.HapticFeedback.impactOccurred('light');
            if(id === 'shop') this.renderShop();
        }

        attackBoss() {
            const b = this.bossList[this.currentBossIndex];
            if (b.hp > 0) {
                tg.HapticFeedback.impactOccurred('medium');
                const isCrit = Math.random() < 0.15;
                const d = isCrit ? this.dmg * 2 : this.dmg;
                b.hp -= d;
                this.showDamage(d, isCrit);
                document.getElementById('boss-avatar').classList.add('shake');
                setTimeout(() => document.getElementById('boss-avatar').classList.remove('shake'), 200);

                if (b.hp <= 0) {
                    this.cigs += b.reward;
                    this.log(`üèÜ –ü–æ–±–µ–¥–∞ –Ω–∞–¥ ${b.name}! +${b.reward} üö¨`);
                    this.currentBossIndex = (this.currentBossIndex + 1) % this.bossList.length;
                    this.bossList[this.currentBossIndex].hp = this.bossList[this.currentBossIndex].maxHp;
                }
                this.updateUI(); this.saveGame();
            }
        }

        doTask() {
            if (this.energy >= 10) {
                this.energy -= 10; this.cigs += 25; this.auth += 40;
                tg.HapticFeedback.notificationOccurred('success');
                this.checkLevelUp(); this.updateUI(); this.saveGame();
            }
        }

        checkLevelUp() {
            if (this.auth >= this.lvl * 120) {
                this.lvl++; this.maxEnergy += 20; this.energy = this.maxEnergy;
                this.log(`‚≠ê –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù: ${this.lvl}!`);
                this.updateStatus();
            }
        }

        updateStatus() {
            const statuses = ["–ü–µ—Ä–≤–æ—Ö–æ–¥", "–®–Ω—ã—Ä—å", "–ú—É–∂–∏–∫", "–ë–ª–∞—Ç–Ω–æ–π", "–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç", "–í–æ—Ä –≤ –∑–∞–∫–æ–Ω–µ"];
            const idx = Math.min(Math.floor(this.lvl / 3), statuses.length - 1);
            document.getElementById('user-status').innerText = statuses[idx];
        }

        renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            this.weapons.forEach(w => {
                const locked = this.lvl < w.lvl;
                const bought = this.ownedWeapons.includes(w.id);
                const item = document.createElement('div');
                item.className = `shop-item ${locked ? 'locked' : ''}`;
                item.innerHTML = `
                    <div class="item-icon">${w.img}</div>
                    <div style="font-weight:bold;font-size:13px;">${w.name}</div>
                    <div style="font-size:10px;color:#4caf50;">+${w.dmg} —É—Ä–æ–Ω–∞</div>
                    <div class="item-price">${bought ? '–ö–£–ü–õ–ï–ù–û' : w.price + ' üö¨'}</div>
                `;
                if (!locked && !bought) item.onclick = () => this.buyWeapon(w);
                grid.appendChild(item);
            });
        }

        buyWeapon(w) {
            if (this.cigs >= w.price) {
                this.cigs -= w.price; this.dmg += w.dmg; this.ownedWeapons.push(w.id);
                tg.HapticFeedback.notificationOccurred('success');
                this.log(`üó°Ô∏è –ö—É–ø–ª–µ–Ω–æ: ${w.name}`);
                this.renderShop(); this.updateUI(); this.saveGame();
            }
        }

        buyTattoo() {
            if (this.cigs >= 100) {
                this.cigs -= 100; this.dmg += 3;
                tg.HapticFeedback.impactOccurred('heavy');
                this.updateUI(); this.saveGame();
            }
        }

        updateUI() {
            document.getElementById('lvl').innerText = this.lvl;
            document.getElementById('cigs').innerText = this.cigs;
            document.getElementById('dmg').innerText = this.dmg;
            document.getElementById('energy').innerText = `${Math.floor(this.energy)}/${this.maxEnergy}`;
            const b = this.bossList[this.currentBossIndex];
            document.getElementById('boss-avatar').src = b.img;
            document.getElementById('boss-name').innerText = b.name;
            document.getElementById('hp-text').innerText = `${Math.max(0, b.hp)}/${b.maxHp} HP`;
            document.getElementById('hp-fill').style.width = `${(b.hp / b.maxHp) * 100}%`;
        }

        showDamage(a, c) {
            const p = document.createElement('div'); p.className = 'damage-popup';
            if(c) p.style.color = '#ffeb3b';
            p.innerText = (c ? 'üî•' : '') + '-' + a;
            document.querySelector('.boss-section').appendChild(p);
            setTimeout(() => p.remove(), 500);
        }

        log(m) {
            const l = document.getElementById('game-log');
            l.innerHTML += `<div>> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        regenEnergy() { if (this.energy < this.maxEnergy) { this.energy += 0.5; this.updateUI(); } }

        saveGame() {
            const d = { lvl: this.lvl, cigs: this.cigs, dmg: this.dmg, bIdx: this.currentBossIndex, bhp: this.bossList[this.currentBossIndex].hp, auth: this.auth, w: this.ownedWeapons };
            localStorage.setItem('prison_save_v3', JSON.stringify(d));
        }

        loadGame() {
            const s = localStorage.getItem('prison_save_v3');
            if (s) {
                const d = JSON.parse(s);
                this.lvl = d.lvl; this.cigs = d.cigs; this.dmg = d.dmg;
                this.currentBossIndex = d.bIdx; this.auth = d.auth; this.ownedWeapons = d.w || [];
                if(this.bossList[this.currentBossIndex]) this.bossList[this.currentBossIndex].hp = d.bhp;
            }
        }
    }
    const game = new PrisonGame();
</script>
</body>
</html>
