<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–¢–Æ–†–Ø–ì–ê: –ë–†–ê–¢–í–ê</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --gold: #f0c571;
            --brown: #2d1a12;
            --orange: #d35400;
            --red: #ff4444;
            --blue: #3498db;
            --bg-dark: #0a0a0a;
        }

        body {
            background: var(--bg-dark) url('https://www.transparenttextures.com/patterns/dark-brick-wall.png');
            color: #fff; font-family: 'Arial Narrow', sans-serif;
            margin: 0; padding: 0; overflow: hidden; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        #setup-screen {
            position: fixed; inset: 0; background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .char-card {
            width: 140px; height: 220px; margin: 10px; border: 3px solid #333;
            background-size: cover; border-radius: 12px; transition: 0.3s;
            filter: grayscale(0.5);
        }
        .-card.selected { border-color: var(--gold); filter: grayscale(0); transform: scale(1.1); box-shadow: 0 0 30px var(--gold); }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar {
            display: grid; grid-template-columns: repeat(4, 1fr);
            background: linear-gradient(to bottom, #4a2b1d, #2d1a12);
            border-bottom: 2px solid #5e3a29; height: 60px; text-align: center;
        }
        .top-bar div { border-right: 1px solid #5e3a29; display: flex; flex-direction: column; justify-content: center; }
        .top-bar span { font-size: 10px; color: #aaa; text-transform: uppercase; }
        .top-bar b { color: var(--gold); font-size: 15px; }

        /* –ò–≥—Ä–æ–≤–æ–π –º–∏—Ä */
        .game-world { position: relative; height: calc(100vh - 60px); width: 100%; }

        /* –°–ª–æ–π –±–æ—Å—Å–∞ */
        .boss-container {
            position: absolute; top: 15px; right: 15px; width: 160px;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px;
            border: 1px solid #5e3a29; z-index: 5;
        }
        .boss-avatar { width: 50px; height: 50px; border-radius: 5px; float: left; margin-right: 10px; border: 1px solid var(--gold); }
        
        /* –ì–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π */
        .hero-view {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 75vh; background-size: contain;
            background-repeat: no-repeat; background-position: center bottom;
            z-index: 2; transition: filter 0.2s;
        }
        .rage-mode { animation: shake 0.1s infinite; filter: sepia(0.3) saturate(3) drop-shadow(0 0 20px red) !important; }

        /* –í—ã–ª–µ—Ç–∞—é—â–∏–π —É—Ä–æ–Ω */
        .damage-popup {
            position: absolute; color: var(--red); font-weight: bold; font-size: 24px;
            pointer-events: none; animation: floatUp 0.6s ease-out forwards; z-index: 100;
            text-shadow: 2px 2px #000;
        }

        /* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é */
        .side-nav { position: absolute; left: 10px; top: 15px; display: flex; flex-direction: column; gap: 12px; z-index: 10; }
        .nav-item {
            width: 50px; height: 50px; background: #3d2419; border: 2px solid #5e3a29;
            border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: inset 0 0 10px #000;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
        .bar-wrap { width: 100%; height: 10px; background: #000; border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1px solid #333; }
        .bar-fill { height: 100%; transition: width 0.3s; }

        /* –ù–∏–∂–Ω—è—è –∑–æ–Ω–∞ */
        .controls { position: absolute; bottom: 25px; width: 100%; text-align: center; z-index: 20; }
        .btn-hit {
            background: linear-gradient(to bottom, #d35400, #8e2d00);
            border: 2px solid var(--gold); color: #fff; padding: 18px 60px;
            font-size: 24px; font-weight: bold; border-radius: 12px;
            box-shadow: 0 6px 0 #4a1a00, 0 10px 20px rgba(0,0,0,0.5);
            text-shadow: 1px 1px 2px #000;
        }
        .btn-hit:active { transform: translateY(4px); box-shadow: 0 2px 0 #4a1a00; }
        .btn-hit:disabled { filter: grayscale(1); opacity: 0.6; }

        /* –û–∫–Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
        .modal {
            display: none; position: fixed; top: 60px; bottom: 0; width: 100%;
            background: rgba(15,8,5,0.98); z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto;
        }
        .modal.active { display: block; animation: fadeIn 0.3s; }
        .item-card { 
            background: linear-gradient(135deg, #2d1a12 0%, #1a0f0a 100%);
            border: 1px solid #5e3a29; padding: 15px; margin-bottom: 12px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }

        @keyframes floatUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-100px); } }
        @keyframes shake { 0% { transform: translate(2px, 2px) translateX(-50%); } 50% { transform: translate(-2px, -3px) translateX(-50%); } 100% { transform: translate(2px, 1px) translateX(-50%); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--gold); text-shadow: 0 0 10px var(--gold);">–ö–¢–û –¢–´ –ü–û –ñ–ò–ó–ù–ò?</h1>
    <div style="display:flex; gap:20px;">
        <div class="-card" id="c1" onclick="game.pick(1)" style="background-image:url('https://i.imgur.com/39A0vW3.png')"></div>
        <div class="-card" id="c2" onclick="game.pick(2)" style="background-image:url('https://i.imgur.com/8pS1S0V.png')"></div>
    </div>
    <button class="btn-hit" onclick="game.start()" style="margin-top:40px">–í –•–ê–¢–£</button>
</div>

<div class="top-bar">
    <div><span>–≠–Ω–µ—Ä–≥–∏—è</span><b id="st-en">0/0</b></div>
    <div><span>–°–∏–ª–∞ ü§ò</span><b id="st-pwr">0</b></div>
    <div><span>–ü–∞–ø–∏—Ä–æ—Å—ã</span><b id="st-cigs">0</b></div>
    <div><span>–£—Ä–æ–≤–µ–Ω—å</span><b id="st-lvl">1</b></div>
</div>

<div class="game-world">
    <div class="side-nav">
        <div class="nav-item" onclick="game.scr('main')">üè†</div>
        <div class="nav-item" onclick="game.scr('quests')">üìú</div>
        <div class="nav-item" onclick="game.scr('shop')">üõí</div>
        <div class="nav-item" onclick="game.scr('ink')">üíâ</div>
    </div>

    <div class="boss-container">
        <img id="b-img" class="boss-avatar" src="">
        <div style="overflow:hidden">
            <b id="b-name" style="color:var(--gold); font-size:14px;"></b>
            <div class="bar-wrap"><div id="hp-fill" class="bar-fill" style="background:var(--red)"></div></div>
            <small id="hp-txt" style="font-size:11px; color:#ccc"></small>
        </div>
    </div>

    <div id="hero" class="hero-view"></div>

    <div class="controls">
        <div style="width:140px; margin: 0 auto 10px;">
            <span style="font-size:10px; color:var(--gold); font-weight:bold;">–Ø–†–û–°–¢–¨</span>
            <div class="bar-wrap" style="height:6px; margin-top:2px;"><div id="rage-fill" class="bar-fill" style="background:var(--gold); width:0%"></div></div>
        </div>
        <button id="hit-btn" class="btn-hit" onclick="game.hit()">–ß–Å –ù–ê?</button>
        <div id="exp-bar" class="bar-wrap" style="width:200px; margin: 10px auto 0; height:4px; border:none;">
            <div id="exp-fill" class="bar-fill" style="background:var(--blue); width:0%"></div>
        </div>
    </div>
</div>

<div id="scr-quests" class="modal">
    <h2 style="color:var(--gold); text-align:center;">–î–ï–õ–ê –¢–Æ–†–ï–ú–ù–´–ï</h2>
    <div id="q-list"></div>
    <button class="btn-hit" style="width:100%; padding:10px;" onclick="game.scr('main')">–ó–ê–ö–†–´–¢–¨</button>
</div>

<div id="scr-shop" class="modal">
    <h2 style="color:var(--gold); text-align:center;">–ú–ê–ì–ê–ó–ò–ù</h2>
    <div class="item-card">
        <div><b>–ß–∏—Ñ–∏—Ä–±–∞–∫</b><br><small style="color:#aaa">–í–æ—Å–ø–æ–ª–Ω–∏—Ç—å –≤—Å—é —ç–Ω–µ—Ä–≥–∏—é</small></div>
        <button class="btn-hit" style="padding:8px 15px; font-size:14px" onclick="game.buy('en')">50 üö¨</button>
    </div>
    <div class="item-card">
        <div><b>–ì–∞–Ω—Ç–µ–ª–∏</b><br><small style="color:#aaa">+10 –∫ —Å–∏–ª–µ ü§ò –Ω–∞–≤—Å–µ–≥–¥–∞</small></div>
        <button class="btn-hit" style="padding:8px 15px; font-size:14px" onclick="game.buy('pwr')">1000 üö¨</button>
    </div>
    <button class="btn-hit" style="width:100%; padding:10px;" onclick="game.scr('main')">–ó–ê–ö–†–´–¢–¨</button>
</div>

<div id="scr-ink" class="modal">
    <h2 style="color:var(--gold); text-align:center;">–ö–û–õ–¨–©–ò–ö</h2>
    <div id="i-list"></div>
    <button class="btn-hit" style="width:100%; padding:10px;" onclick="game.scr('main')">–ó–ê–ö–†–´–¢–¨</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

class PrisonGame {
    constructor() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const save = JSON.parse(localStorage.getItem('prison_v3')) || {};
        this.cigs = save.cigs ?? 1000;
        this.pwr = save.pwr ?? 15;
        this.en = save.en ?? 50;
        this.maxEn = save.maxEn ?? 50;
        this.lvl = save.lvl ?? 1;
        this.exp = save.exp ?? 0;
        this.my = save.my ?? '';
        this.myTattoos = save.myTattoos ?? [];
        this.bIdx = save.bIdx ?? 0;

        this.rage = 0;
        this.isRage = false;

        this.bosses = [
            { n: "–ö–∏—Ä–ø–∏—á", hp: 1500, m: 1500, rew: 300, img: 'https://i.imgur.com/8pS1S0V.png' },
            { n: "–°–∏–∑—ã–π", hp: 10000, m: 10000, rew: 1500, img: 'https://i.imgur.com/8pS1S0V.png' },
            { n: "–ú–∞—Ö–Ω–æ", hp: 50000, m: 50000, rew: 6000, img: 'https://i.imgur.com/8pS1S0V.png' },
            { n: "–®–∞–π–±–∞", hp: 250000, m: 250000, rew: 25000, img: 'https://i.imgur.com/8pS1S0V.png' }
        ];

        this.tattoos = [
            { id: 't1', n: "–ü–µ—Ä—Å—Ç–µ–Ω—å", cost: 1500, dmg: 30 },
            { id: 't2', n: "–ó–≤–µ–∑–¥—ã", cost: 8000, dmg: 150 },
            { id: 't3', n: "–ö—É–ø–æ–ª–∞", cost: 35000, dmg: 800 }
        ];

        this.quests = [
            { n: "–ù–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫", en: 10, rew: 400, exp: 50 },
            { n: "–°—ã–≥—Ä–∞—Ç—å –≤ –±—É—Ä—É", en: 25, rew: 1200, exp: 150 }
        ];

        if(this.my) {
            document.getElementById('setup-screen').style.display = 'none';
            this.setHero();
        }

        this.init();
    }

    init() {
        this.update();
        setInterval(() => this.regen(), 8000); // –†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏ –∫–∞–∂–¥—ã–µ 8 —Å–µ–∫
    }

    save() {
        const data = { cigs: this.cigs, pwr: this.pwr, en: this.en, maxEn: this.maxEn, lvl: this.lvl, exp: this.exp, myChar: this.myChar, myTattoos: this.myTattoos, bIdx: this.bIdx };
        localStorage.setItem('prison_v3', JSON.stringify(data));
    }

    pick(id) {
        this.myChar = id === 1 ? 'zk1.jpg' : 'zk1.jpg';
        document.getElementById('c1').classList.toggle('selected', id === 1);
        document.getElementById('c2').classList.toggle('selected', id === 2);
    }

    start() {
        if(!this.myChar) return tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –º–∞—Å—Ç—å!");
        document.getElementById('setup-screen').style.display = 'none';
        this.setHero();
        this.save();
    }

    setHero() { document.getElementById('hero').style.backgroundImage = `url(${this.myChar})`; }

    scr(id) {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        if(id !== 'main') document.getElementById('scr-' + id).classList.add('active');
        if(id === 'quests') this.renderQuests();
        if(id === 'ink') this.renderInk();
    }

    hit(e) {
        if(this.en <= 0) return tg.showAlert("–≠–Ω–µ—Ä–≥–∏—è –Ω–∞ –Ω—É–ª–µ, –æ—Ç–¥–æ—Ö–Ω–∏!");
        
        this.en--;
        let dmg = this.pwr;
        this.myTattoos.forEach(tid => {
            const t = this.tattoos.find(x => x.id === tid);
            if(t) dmg += t.dmg;
        });

        if(this.isRage) dmg *= 5;
        else { this.rage += 4; if(this.rage >= 100) this.startRage(); }

        this.bosses[this.bIdx].hp -= dmg;
        this.exp += 2;

        // –≠—Ñ—Ñ–µ–∫—Ç—ã
        this.showDmg(dmg);
        tg.HapticFeedback.impactOccurred(this.isRage ? 'heavy' : 'light');

        if(this.bosses[this.bIdx].hp <= 0) this.winBoss();
        
        this.checkLvl();
        this.update();
        this.save();
    }

    showDmg(d) {
        const p = document.createElement('div');
        p.className = 'damage-popup';
        p.innerText = `-${d}`;
        p.style.left = (Math.random() * 40 + 40) + '%';
        p.style.top = '30%';
        document.querySelector('.game-world').appendChild(p);
        setTimeout(() => p.remove(), 600);
    }

    startRage() {
        this.isRage = true; this.rage = 100;
        document.getElementById('hero').classList.add('rage-mode');
        setTimeout(() => {
            this.isRage = false; this.rage = 0;
            document.getElementById('hero').classList.remove('rage-mode');
            this.update();
        }, 6000);
    }

    winBoss() {
        const b = this.bosses[this.bIdx];
        this.cigs += b.rew;
        this.exp += b.rew / 4;
        tg.showAlert(`–ö–†–ê–°–ê–í–ê! ${b.n} –ø–æ–≤–µ—Ä–∂–µ–Ω. –¢–≤–æ–π –∫—É—à: ${b.rew} üö¨`);
        this.bIdx = (this.bIdx + 1) % this.bosses.length;
        this.bosses[this.bIdx].hp = this.bosses[this.bIdx].m;
    }

    checkLvl() {
        let need = this.lvl * 300;
        if(this.exp >= need) {
            this.lvl++; this.exp = 0;
            this.maxEn += 10; this.en = this.maxEn;
            this.pwr += 5;
            tg.showAlert(`–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –¢–µ–ø–µ—Ä—å —Ç—ã ${this.lvl} —É—Ä–æ–≤–Ω—è.`);
        }
    }

    buy(type) {
        if(type === 'en' && this.cigs >= 50) { this.cigs -= 50; this.en = this.maxEn; }
        if(type === 'pwr' && this.cigs >= 1000) { this.cigs -= 1000; this.pwr += 10; }
        this.update(); this.save();
    }

    renderQuests() {
        document.getElementById('q-list').innerHTML = this.quests.map(q => `
            <div class="item-card">
                <div><b>${q.n}</b><br><small>–ù–∞–≥—Ä–∞–¥–∞: ${q.rew} üö¨ | Exp: +${q.exp}</small></div>
                <button class="btn-hit" style="padding:10px; font-size:14px" onclick="game.doQuest('${q.n}')">-${q.en}‚ö°</button>
            </div>
        `).join('');
    }

    doQuest(name) {
        const q = this.quests.find(x => x.n === name);
        if(this.en >= q.en) {
            this.en -= q.en; this.cigs += q.rew; this.exp += q.exp;
            tg.HapticFeedback.notificationOccurred('success');
            this.checkLvl(); this.update(); this.renderQuests(); this.save();
        } else tg.showAlert("–ú–∞–ª–æ–≤–∞—Ç–æ —ç–Ω–µ—Ä–≥–∏–∏!");
    }

    renderInk() {
        document.getElementById('i-list').innerHTML = this.tattoos.map(t => `
            <div class="item-card">
                <div><b>${t.n}</b><br><small>–£—Ä–æ–Ω: +${t.dmg} ü§ò</small></div>
                <button class="btn-hit" style="padding:10px; font-size:14px" onclick="game.buyInk('${t.id}', ${t.cost})" 
                ${this.myTattoos.includes(t.id)?'disabled':''}>${t.cost} üö¨</button>
            </div>
        `).join('');
    }

    buyInk(id, cost) {
        if(this.cigs >= cost) {
            this.cigs -= cost; this.myTattoos.push(id);
            tg.HapticFeedback.notificationOccurred('success');
            this.update(); this.renderInk(); this.save();
        }
    }

    regen() { if(this.en < this.maxEn) { this.en++; this.update(); } }

    update() {
        document.getElementById('st-en').innerText = `${this.en}/${this.maxEn}`;
        document.getElementById('st-pwr').innerText = this.pwr;
        document.getElementById('st-cigs').innerText = Math.floor(this.cigs);
        document.getElementById('st-lvl').innerText = this.lvl;
        
        const b = this.bosses[this.bIdx];
        document.getElementById('b-name').innerText = b.n;
        document.getElementById('b-img').src = b.img;
        document.getElementById('hp-fill').style.width = (b.hp/b.m*100)+'%';
        document.getElementById('hp-txt').innerText = `${Math.ceil(b.hp)}/${b.m} HP`;
        document.getElementById('rage-fill').style.width = this.rage + '%';
        document.getElementById('exp-fill').style.width = (this.exp / (this.lvl * 300) * 100) + '%';
        document.getElementById('hit-btn').disabled = (this.en <= 0);
    }
}
const game = new PrisonGame();
</script>
</body>
</html>

