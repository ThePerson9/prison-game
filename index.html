<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–¢—é—Ä—è–≥–∞: Telegram Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: #0f0f0f;
            --tg-text: #ffffff;
            --tg-btn: #3390ec;
            --danger: #ff4444;
            --gold: #ffd700;
            --gray: #2c2c2c;
        }
        body { background: var(--tg-bg); color: var(--tg-text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 10px; overflow-x: hidden; user-select: none; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .tabs { display: flex; gap: 4px; margin-bottom: 10px; sticky: top; }
        .tab-btn { flex: 1; padding: 10px 2px; text-align: center; font-size: 9px; font-weight: bold; background: var(--gray); border-radius: 8px; cursor: pointer; border: 1px solid #333; transition: 0.2s; }
        .tab-btn.active { background: var(--tg-btn); border-color: var(--tg-btn); transform: translateY(-2px); }

        .game-screen { display: none; animation: fadeIn 0.3s; }
        .game-screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –°–æ–±—ã—Ç–∏—è */
        #event-bar { background: var(--danger); text-align: center; padding: 6px; font-size: 11px; font-weight: bold; display: none; border-radius: 8px; margin-bottom: 10px; }

        /* –°—Ç–∞—Ç—ã */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .stat-item { background: #1a1a1a; padding: 10px; border-radius: 12px; border: 1px solid #333; }
        .stat-item small { color: #888; font-size: 10px; display: block; }
        .stat-item b { font-size: 16px; color: var(--tg-btn); }
        .teeth-count { color: var(--gold) !important; }

        /* –ë–æ—Å—Å */
        .boss-container { text-align: center; padding: 15px; background: radial-gradient(circle, #222 0%, #000 100%); border-radius: 20px; border: 1px solid #333; margin-bottom: 10px; }
        .hp-bar { height: 12px; background: #333; border-radius: 6px; margin: 10px 0; overflow: hidden; border: 1px solid #444; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #ff4444, #880000); width: 100%; transition: 0.2s; }

        /* –ü–æ–≥–æ–Ω—è–ª–∞ –∏ –†–∞–Ω–≥–∏ */
        .rank-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; margin-right: 5px; color: #fff; text-transform: uppercase; }
        .rank-newbie { background: #666; } .rank-thug { background: #e67e22; } .rank-king { background: var(--gold); color: #000; }

        /* –ß–∞—Ç */
        .chat-box { background: #000; height: 120px; border-radius: 10px; padding: 8px; overflow-y: auto; border: 1px solid #222; margin-top: 10px; font-size: 11px; }
        .msg { margin-bottom: 4px; border-bottom: 1px solid #111; }
        .msg b { color: var(--tg-btn); }

        /* –¢–∞—Ç—É */
        .tattoo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .tattoo-slot { aspect-ratio: 1/1; background: #1a1a1a; border: 2px dashed #333; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; }
        .tattoo-slot.active { border: 2px solid var(--tg-btn); background: #000; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { background: var(--tg-btn); color: #fff; border: none; padding: 14px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.1s; -webkit-tap-highlight-color: transparent; }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-locked { background: #444; opacity: 0.5; }

        .leaderboard-item { display: flex; align-items: center; background: #1a1a1a; padding: 10px; border-radius: 10px; margin-bottom: 5px; border: 1px solid #222; }
    </style>
</head>
<body>

<div id="event-bar"></div>

<div class="tabs">
    <div class="tab-btn active" onclick="game.scr('main')">üëä –ë–û–ô</div>
    <div class="tab-btn" onclick="game.scr('ink')">üíâ –¢–ê–¢–£</div>
    <div class="tab-btn" onclick="game.scr('clan')">üè¢ –ë–ê–ù–î–ê</div>
    <div class="tab-btn" onclick="game.scr('market')">üíÄ –†–´–ù–û–ö</div>
    <div class="tab-btn" onclick="game.scr('top')">üèÜ –¢–û–ü</div>
</div>

<div id="s-main" class="game-screen active">
    <div class="stat-grid">
        <div class="stat-item"><small>–ü–∞–ø–∏—Ä–æ—Å—ã / –ó—É–±—ã</small><b id="st-cigs">0</b></div>
        <div class="stat-item"><small>–¢–≤–æ–π —É—Ä–æ–Ω</small><b id="st-dmg">10</b></div>
    </div>
    
    <div class="boss-container">
        <h4 id="b-name" style="margin:0 0 10px 0">–ú–ê–ô–û–†</h4>
        <img src="https://i.imgur.com/8pS1S0V.png" style="width:100px; filter: drop-shadow(0 0 10px rgba(255,0,0,0.5));">
        <div class="hp-bar"><div id="hp-fill" class="hp-fill"></div></div>
        <div id="hp-text" style="font-size:12px">100/100</div>
    </div>
    
    <button class="btn" onclick="game.hit()">–£–î–ê–†–ò–¢–¨</button>
    <button id="hide-btn" class="btn btn-gold" style="display:none; margin-top:5px" onclick="game.hideCigs()">üì¶ –°–ü–†–Ø–¢–ê–¢–¨ –ü–ê–ü–ò–†–û–°–´</button>
</div>

<div id="s-ink" class="game-screen">
    <h3 style="text-align:center">–ö–æ–ª—å—â–∏–∫</h3>
    <div class="tattoo-grid" id="tattoo-grid"></div>
    <div id="ink-info" style="display:none; margin-top:15px; background:#1a1a1a; padding:15px; border-radius:12px; border:1px solid #333;">
        <h4 id="ink-name" style="margin:0"></h4>
        <p id="ink-desc" style="font-size:12px; color:#aaa"></p>
        <button class="btn" id="ink-buy-btn">–ù–ê–ë–ò–¢–¨</button>
    </div>
</div>

<div id="s-clan" class="game-screen">
    <div style="background:var(--gray); padding:15px; border-radius:12px; text-align:center; border:1px solid var(--gold)">
        <h3 style="margin:0; color:var(--gold)">–ß–µ—Ä–Ω—ã–µ –î–µ–ª—å—Ñ–∏–Ω—ã</h3>
        <small>–û–±—â–∞–∫: <span id="st-obshek">0</span> üö¨</small>
        <button class="btn btn-gold" style="margin-top:10px; padding:8px" onclick="game.donate()">–í–ö–ò–ù–£–¢–¨ 100 üö¨</button>
    </div>
    
    <div class="chat-box" id="chat-messages"></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px">
        <button class="tab-btn" onclick="game.sendMsg('–í–µ—á–µ—Ä –≤ —Ö–∞—Ç—É!')">üëã –°–∞–ª–∞–º</button>
        <button class="tab-btn" onclick="game.sendMsg('–ñ–º–∏ –Ω–∞ –±–æ—Å—Å–∞!')">üëä –ñ–º–∏!</button>
    </div>
</div>

<div id="s-market" class="game-screen">
    <h3 style="text-align:center; color:var(--gold)">–ß–µ—Ä–Ω—ã–π —Ä—ã–Ω–æ–∫</h3>
    <div id="market-list"></div>
    
    <hr style="border:0; border-top:1px solid #333; margin:20px 0">
    
    <div style="background:linear-gradient(45deg, #111, #222); padding:15px; border-radius:12px; border:1px solid #f1c40f; text-align:center">
        <h4 style="margin:0">–ü–ª–∞–Ω –ü–æ–±–µ–≥–∞</h4>
        <p style="font-size:11px">–ó–∞ –∫–∞–∂–¥—ã–µ 100–∫ –ø–∞–ø–∏—Ä–æ—Å —Ç—ã –ø–æ–ª—É—á–∏—à—å 1 –∑—É–±, –Ω–æ –Ω–∞—á–Ω–µ—à—å –∑–∞–Ω–æ–≤–æ.</p>
        <button class="btn btn-gold" onclick="game.escape()">–£–ô–¢–ò –í –ë–ï–ì–ê (<span id="p-teeth">0</span> ü¶∑)</button>
    </div>
</div>

<div id="s-top" class="game-screen">
    <h3 style="text-align:center">–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç—ã</h3>
    <div id="leader-list"></div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

class PrisonGame {
    constructor() {
        // –ë–∞–∑–æ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã
        this.cigs = 500;
        this.teeth = 0;
        this.dmg = 10;
        this.obshek = 1000;
        this.myDonated = 0;
        this.myTattoos = [];
        this.myPets = { 'rat': 0 };
        this.userName = tg.initDataUnsafe?.user?.first_name || "–ê—Ä–µ—Å—Ç–∞–Ω—Ç";
        
        // –ë–æ—Å—Å
        this.boss = { hp: 500, m: 500 };
        
        // –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
        this.ranks = [
            { n: "–®–Ω—ã—Ä—å", req: 0, b: 0, c: "rank-newbie" },
            { n: "–ú—É–∂–∏–∫", req: 1000, b: 10, c: "rank-newbie" },
            { n: "–ë—ã–≤–∞–ª—ã–π", req: 10000, b: 50, c: "rank-thug" },
            { n: "–í–æ—Ä –≤ –∑–∞–∫–æ–Ω–µ", req: 50000, b: 200, c: "rank-king" }
        ];
        
        this.tattoos = [
            { id: 'ring', n: "–ü–µ—Ä—Å—Ç–µ–Ω—å", b: "+5% —É—Ä–æ–Ω–∞", cost: 1000, icon: "üíç" },
            { id: 'stars', n: "–ó–≤–µ–∑–¥—ã", b: "+20 —É—Ä–æ–Ω–∞", cost: 5000, icon: "‚≠ê" },
            { id: 'domes', n: "–ö—É–ø–æ–ª–∞", b: "+50% —É—Ä–æ–Ω–∞", cost: 25000, icon: "‚õ™" }
        ];

        this.petData = {
            'rat': { n: "–ö—Ä—ã—Å–∞", cost: 1, dmg: 2, icon: "üêÄ" },
            'crow': { n: "–í–æ—Ä–æ–Ω", cost: 5, dmg: 10, icon: "üê¶" }
        };

        this.currentEvent = null;
        this.eventTimer = 0;

        this.load();
        this.update();
        setInterval(() => this.tick(), 1000);
    }

    // –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    save() {
        const data = { cigs: this.cigs, teeth: this.teeth, tattoos: this.myTattoos, obshek: this.obshek, donated: this.myDonated, pets: this.myPets };
        localStorage.setItem('prison_data_final', JSON.stringify(data));
    }

    load() {
        const s = JSON.parse(localStorage.getItem('prison_data_final'));
        if(s) {
            this.cigs = s.cigs; this.teeth = s.teeth; this.myTattoos = s.tattoos;
            this.obshek = s.obshek; this.myDonated = s.donated; this.myPets = s.pets || this.myPets;
        }
    }

    scr(id) {
        document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('s-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
        
        if(id === 'ink') this.renderInk();
        if(id === 'market') this.renderMarket();
        if(id === 'top') this.renderTop();
    }

    // –ì–µ–π–º–ø–ª–µ–π
    get totalDmg() {
        let b = this.dmg;
        const rank = this.getCurrentRank();
        b += rank.b;
        
        if(this.myTattoos.includes('stars')) b += 20;
        if(this.myTattoos.includes('ring')) b *= 1.05;
        if(this.myTattoos.includes('domes')) b *= 1.5;
        if(this.currentEvent?.id === 'riot') b *= 3;
        
        return Math.floor(b);
    }

    getCurrentRank() {
        let r = this.ranks[0];
        for(let rank of this.ranks) if(this.myDonated >= rank.req) r = rank;
        return r;
    }

    hit() {
        this.boss.hp -= this.totalDmg;
        tg.HapticFeedback.impactOccurred('light');
        if(this.boss.hp <= 0) {
            this.cigs += 150 * (1 + (this.teeth * 0.1));
            this.boss.hp = this.boss.m;
            tg.HapticFeedback.notificationOccurred('success');
        }
        this.save(); this.update();
    }

    tick() {
        // –ê–≤—Ç–æ-—É—Ä–æ–Ω –ø–∏—Ç–æ–º—Ü–µ–≤
        let pDmg = 0;
        for(let id in this.myPets) pDmg += this.myPets[id] * this.petData[id].dmg;
        if(pDmg > 0) {
            this.boss.hp -= pDmg;
            if(this.boss.hp <= 0) this.hit();
            this.update();
        }

        // –°–æ–±—ã—Ç–∏—è
        if(this.eventTimer > 0) {
            this.eventTimer--;
            if(this.eventTimer <= 0) this.currentEvent = null;
            this.update();
        } else if(Math.random() < 0.01) {
            this.startEvent();
        }
    }

    startEvent() {
        const evs = [
            {id:'riot', n:'üî• –ë–£–ù–¢: –£—Ä–æ–Ω x3', c:'#c0392b'},
            {id:'search', n:'üîç –®–ú–û–ù: –ü—Ä—è—á—å –ø–∞–ø–∏—Ä–æ—Å—ã!', c:'#d35400'}
        ];
        this.currentEvent = evs[Math.floor(Math.random()*evs.length)];
        this.eventTimer = 60;
        this.sendMsg("–ù–∞—á–∞–ª–æ—Å—å —Å–æ–±—ã—Ç–∏–µ: " + this.currentEvent.n, "–°–ò–°–¢–ï–ú–ê");
    }

    hideCigs() {
        if(this.currentEvent?.id === 'search') {
            this.currentEvent = null;
            tg.showAlert("–£—Å–ø–µ–ª –ø—Ä–∏–ø—Ä—è—Ç–∞—Ç—å!");
            this.update();
        }
    }

    donate() {
        if(this.cigs >= 100) {
            this.cigs -= 100; this.obshek += 100; this.myDonated += 100;
            this.sendMsg("–ó–∞–∫–∏–Ω—É–ª –≤ –æ–±—â–∞–∫! üö¨");
            this.save(); this.update();
        }
    }

    escape() {
        const reward = Math.floor(this.cigs / 100000);
        if(reward < 1) return tg.showAlert("–ù—É–∂–Ω–æ 100–∫ –ø–∞–ø–∏—Ä–æ—Å!");
        this.teeth += reward; this.cigs = 500; this.myTattoos = []; this.myDonated = 0;
        this.save(); this.update(); this.scr('main');
    }

    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    update() {
        document.getElementById('st-cigs').innerHTML = `${Math.floor(this.cigs)} üö¨ | <span class="teeth-count">${this.teeth} ü¶∑</span>`;
        document.getElementById('st-dmg').innerText = this.totalDmg;
        document.getElementById('st-obshek').innerText = this.obshek;
        document.getElementById('p-teeth').innerText = Math.floor(this.cigs / 100000);
        
        document.getElementById('hp-fill').style.width = (this.boss.hp/this.boss.m*100)+'%';
        document.getElementById('hp-text').innerText = `${this.boss.hp}/${this.boss.m} HP`;

        const eb = document.getElementById('event-bar');
        if(this.currentEvent) {
            eb.style.display = 'block'; eb.style.background = this.currentEvent.c;
            eb.innerText = `${this.currentEvent.n} (${this.eventTimer}—Å)`;
            if(this.currentEvent.id === 'search') document.getElementById('hide-btn').style.display = 'block';
        } else {
            eb.style.display = 'none';
            document.getElementById('hide-btn').style.display = 'none';
        }
    }

    renderInk() {
        const g = document.getElementById('tattoo-grid'); g.innerHTML = '';
        this.tattoos.forEach(t => {
            const owned = this.myTattoos.includes(t.id);
            g.innerHTML += `<div class="tattoo-slot ${owned?'active':''}" onclick="game.selInk('${t.id}')">${t.icon}</div>`;
        });
    }

    selInk(id) {
        const t = this.tattoos.find(x => x.id === id);
        const owned = this.myTattoos.includes(id);
        const info = document.getElementById('ink-info');
        info.style.display = 'block';
        document.getElementById('ink-name').innerText = t.n;
        document.getElementById('ink-desc').innerText = `${t.b}. –¶–µ–Ω–∞: ${t.cost} üö¨`;
        const btn = document.getElementById('ink-buy-btn');
        btn.disabled = owned || this.cigs < t.cost;
        btn.innerText = owned ? "–ù–ê–ë–ò–¢–û" : "–ö–£–ü–ò–¢–¨";
        btn.onclick = () => {
            this.cigs -= t.cost; this.myTattoos.push(id);
            this.save(); this.update(); this.renderInk(); this.selInk(id);
        }
    }

    renderMarket() {
        const l = document.getElementById('market-list'); l.innerHTML = '';
        for(let id in this.petData) {
            const p = this.petData[id]; const lvl = this.myPets[id] || 0;
            l.innerHTML += `
                <div class="leaderboard-item">
                    <span style="font-size:24px">${p.icon}</span>
                    <div style="flex:1; margin-left:10px"><b>${p.n}</b> (–£—Ä. ${lvl})<br><small>–£—Ä–æ–Ω: ${p.dmg*lvl}/—Å</small></div>
                    <button class="btn btn-gold" style="width:auto; padding:5px 10px" onclick="game.buyPet('${id}')" ${this.teeth < p.cost ? 'disabled':''}>${p.cost} ü¶∑</button>
                </div>`;
        }
    }

    buyPet(id) {
        if(this.teeth >= this.petData[id].cost) {
            this.teeth -= this.petData[id].cost; this.myPets[id]++;
            this.save(); this.update(); this.renderMarket();
        }
    }

    renderTop() {
        const l = document.getElementById('leader-list');
        const players = [
            {n: "–°–∏–∑—ã–π", t: 50, r: "–í–æ—Ä –≤ –∑–∞–∫–æ–Ω–µ"},
            {n: this.userName + " (–í–´)", t: this.teeth, r: this.getCurrentRank().n, me: true},
            {n: "–•–º—É—Ä—ã–π", t: 15, r: "–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç"}
        ].sort((a,b) => b.t - a.t);
        
        l.innerHTML = players.map((p, i) => `
            <div class="leaderboard-item ${p.me?'me-highlight':''}">
                <b style="width:20px">${i+1}</b>
                <div style="flex:1"><b>${p.n}</b><br><small>${p.r}</small></div>
                <b class="teeth-count">${p.t} ü¶∑</b>
            </div>
        `).join('');
    }

    sendMsg(txt, sender = null) {
        const b = document.getElementById('chat-messages');
        const r = this.getCurrentRank();
        const name = sender || this.userName;
        b.innerHTML += `<div class="msg"><span class="rank-badge ${sender?'rank-king':r.c}">${sender?'–ë–û–°–°':r.n}</span> <b>${name}:</b> ${txt}</div>`;
        b.scrollTop = b.scrollHeight;
        if(!sender) setTimeout(() => this.sendMsg("–ë–∞–∑–∞—Ä—É –Ω–æ–ª—å!", "–õ—ë—Ö–∞"), 2000);
    }
}

const game = new PrisonGame();
</script>
</body>
</html>
