<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–¢–Æ–†–Ø–ì–ê: –ö–õ–ê–ù–û–í–´–ï –í–û–ô–ù–´</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap');
        :root { --gold: #ffcc00; --red: #ff3300; --bg: #0a0a0a; --panel: #1a1a1a; --border: #3d2b1f; }
        * { box-sizing: border-box; font-family: 'Oswald', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #ccc; margin: 0; overflow: hidden; height: 100vh; }

        /* HEADER */
        .top-bar {
            display: grid; grid-template-columns: repeat(4, 1fr); background: linear-gradient(180deg, #2c1e18, #110d0a);
            border-bottom: 3px solid var(--border); height: 75px; z-index: 100;
        }
        .s-box { display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #2d1e15; }
        .s-val { font-size: 15px; color: var(--gold); }
        .p-bar { width: 80%; height: 5px; background: #000; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .p-fill { height: 100%; transition: width 0.4s; }

        /* GAME AREA */
        .world { position: relative; height: calc(100vh - 150px); width: 100%; background: radial-gradient(circle, #222, #000); }
        .char-img { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); max-width: 120%; height: 85%; object-fit: contain; filter: drop-shadow(0 0 25px #000); transition: 0.1s; }
        .rage { animation: shake 0.1s infinite; filter: saturate(5) drop-shadow(0 0 40px var(--red)) !important; }

        /* BOTTOM NAV */
        .nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: #111; border-top: 2px solid var(--border); display: grid; grid-template-columns: repeat(5, 1fr); z-index: 200; }
        .nav-i { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; opacity: 0.6; }
        .nav-i.active { opacity: 1; color: var(--gold); border-top: 2px solid var(--gold); }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; }
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .btn { background: var(--gold); color: #000; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; text-transform: uppercase; }

        /* POPUPS */
        .dmg { position: absolute; color: #fff; font-size: 45px; font-weight: 900; text-shadow: 3px 3px #000; animation: fly 0.8s forwards; pointer-events: none; z-index: 500; }
        @keyframes fly { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-160px) scale(1.6); } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -2px); } }

        /* CLAN TAG */
        .clan-tag { position: absolute; top: 100px; left: 20px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-left: 4px solid var(--gold); font-weight: bold; z-index: 60; }
    </style>
</head>
<body>

<div id="start-scr" style="position:fixed; inset:0; background:#000; z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <h1 style="color:var(--gold); font-size: 50px;">–¢–Æ–†–Ø–ì–ê</h1>
    <p>–ö–õ–ê–ù–û–í–´–ï –í–û–ô–ù–´ 2026</p>
    <div style="display:flex; gap:20px; margin:40px 0;">
        <div id="p1" onclick="core.pick(1)" style="width:120px; height:180px; border:3px solid #333; border-radius:15px; background:url('https://i.imgur.com/39A0vW3.png') center/cover;"></div>
        <div id="p2" onclick="core.pick(2)" style="width:120px; height:180px; border:3px solid #333; border-radius:15px; background:url('https://i.imgur.com/8pS1S0V.png') center/cover;"></div>
    </div>
    <button class="btn" style="width:250px; height:60px; font-size:20px;" onclick="core.enter()">–í–û–ô–¢–ò –í –•–ê–¢–£</button>
</div>

<div class="top-bar">
    <div class="s-box"><span>–≠–Ω–µ—Ä–≥–∏—è ‚ö°</span><b id="st-en">0/0</b><div class="p-bar"><div id="f-en" class="p-fill" style="background:var(--red)"></div></div></div>
    <div class="s-box"><span>–°–∏–ª–∞ ü§ò</span><b id="st-pwr">0</b><div class="p-bar"><div id="f-rage" class="p-fill" style="background:var(--gold); width:0%"></div></div></div>
    <div class="s-box"><span>–ü–∞–ø–∏—Ä–æ—Å—ã</span><b id="st-cigs">0</b></div>
    <div class="s-box"><span>–£—Ä–æ–≤–µ–Ω—å</span><b id="st-lvl">1</b><div class="p-bar"><div id="f-exp" class="p-fill" style="background:var(--gold)"></div></div></div>
</div>

<div class="world">
    <div id="clan-display" class="clan-tag">–ë–ï–ó –ë–†–ò–ì–ê–î–´</div>
    <div style="position:absolute; top:15px; width:90%; left:5%; background:rgba(0,0,0,0.8); padding:10px; border-radius:10px; z-index:50;">
        <div style="display:flex; justify-content:space-between;"><b id="b-name">–ë–û–°–°</b><b id="b-hp">0 HP</b></div>
        <div class="p-bar" style="width:100%"><div id="f-hp" class="p-fill" style="background:var(--red)"></div></div>
    </div>
    <img id="char-img" class="char-img" src="">
    <div style="position:absolute; bottom:90px; width:100%; text-align:center;">
        <button class="btn" style="width:80%; height:70px; font-size:24px; box-shadow: 0 5px 0 #930;" onclick="core.hit(event)">–ß–Å –ù–ê?!</button>
    </div>
</div>

<nav class="nav">
    <div class="nav-i active" onclick="core.scr('main')"><span>üè†</span><label>–•–∞—Ç–∞</label></div>
    <div class="nav-i" onclick="core.scr('quests')"><span>üìú</span><label>–î–≤–∏–∂—É—Ö–∏</label></div>
    <div class="nav-i" onclick="core.scr('clans')"><span>üõ°Ô∏è</span><label>–ë—Ä–∏–≥–∞–¥—ã</label></div>
    <div class="nav-i" onclick="core.scr('pvp')"><span>üëä</span><label>–ù–∞–µ–∑–¥—ã</label></div>
    <div class="nav-i" onclick="core.scr('shop')"><span>üíâ</span><label>–ö–æ–ª—å—â–∏–∫</label></div>
</nav>

<div id="m-quests" class="modal"><h2>–î–í–ò–ñ–£–•–ò</h2><div id="q-list"></div><br><button class="btn" onclick="core.scr()">–ó–ê–ö–†–´–¢–¨</button></div>
<div id="m-clans" class="modal"><h2>–ë–†–ò–ì–ê–î–´</h2><div id="cl-list"></div><br><button class="btn" onclick="core.scr()">–ó–ê–ö–†–´–¢–¨</button></div>
<div id="m-pvp" class="modal"><h2>–ù–ê–ï–ó–î–´ –ù–ê –õ–û–•–û–í</h2><div id="pvp-list"></div><br><button class="btn" onclick="core.scr()">–ó–ê–ö–†–´–¢–¨</button></div>
<div id="m-shop" class="modal"><h2>–ö–û–õ–¨–©–ò–ö</h2><div id="s-list"></div><br><button class="btn" onclick="core.scr()">–ó–ê–ö–†–´–¢–¨</button></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const core = {
    u: { en:100, mEn:100, pwr:30, cigs:500, lvl:1, exp:0, char:'', bIdx:0, rage:0, tats:[], clan: null },
    bosses: [{n:"–ö–ò–†–ü–ò–ß", hp:5000, m:5000, r:1000}, {n:"–°–ò–ó–´–ô", hp:25000, m:25000, r:5000}],
    clans: [{n:"–ß–ï–†–ù–´–ï –î–ï–õ–¨–§–ò–ù–´", c:5000, b:200}, {n:"–°–ï–í–ï–†–ù–´–ô –í–ï–¢–ï–†", c:15000, b:600}],

    init() {
        const s = localStorage.getItem('prison_final_v3');
        if(s) this.u = Object.assign(this.u, JSON.parse(s));
        if(this.u.char) { document.getElementById('start-scr').style.display='none'; document.getElementById('char-img').src=this.u.char; }
        this.render();
        setInterval(()=>this.loop(), 3000);
    },

    save() { localStorage.setItem('prison_final_v3', JSON.stringify(this.u)); },

    pick(i) {
        this.u.char = i===1 ? 'https://i.imgur.com/39A0vW3.png' : 'https://i.imgur.com/8pS1S0V.png';
        document.getElementById('p1').style.borderColor = i===1?'var(--gold)':'#333';
        document.getElementById('p2').style.borderColor = i===2?'var(--gold)':'#333';
    },

    enter() { if(this.u.char) { document.getElementById('start-scr').style.display='none'; document.getElementById('char-img').src=this.u.char; this.save(); } },

    hit(e) {
        if(this.u.en < 1) return tg.showAlert("–ú–∞–ª–æ –Ω—ã—Ä–∫–æ–≤!");
        this.u.en--;
        let d = this.u.pwr;
        if(this.u.rage >= 100) { d *= 10; this.u.rage = 0; this.rageEffect(); } else { this.u.rage += 5; }
        this.bosses[this.u.bIdx].hp -= d;
        this.u.exp += 10;
        this.pop(e, `-${d}`);
        tg.HapticFeedback.impactOccurred('heavy');
        if(this.bosses[this.u.bIdx].hp <= 0) this.win();
        this.checkLvl(); this.render(); this.save();
    },

    rageEffect() {
        const img = document.getElementById('char-img');
        img.classList.add('rage'); setTimeout(()=>img.classList.remove('rage'), 3000);
    },

    pop(e, v) {
        const d = document.createElement('div'); d.className='dmg'; d.innerText=v;
        d.style.left = e.clientX+'px'; d.style.top = e.clientY+'px';
        document.body.appendChild(d); setTimeout(()=>d.remove(), 800);
    },

    win() {
        const b = this.bosses[this.u.bIdx];
        this.u.cigs += b.r; tg.showAlert(`–ë–û–°–° –£–ü–ê–õ! –ì—Ä–µ–≤: ${b.r} üö¨`);
        this.u.bIdx = (this.u.bIdx+1)%this.bosses.length;
        this.bosses[this.u.bIdx].hp = this.bosses[this.u.bIdx].m;
    },

    checkLvl() {
        if(this.u.exp >= this.u.lvl*1000) { this.u.lvl++; this.u.exp=0; this.u.mEn+=20; this.u.pwr+=15; tg.showAlert("–ù–û–í–´–ô –£–†–û–í–ï–ù–¨!"); }
    },

    loop() { if(this.u.en < this.u.mEn) { this.u.en += 0.5; this.render(); } },

    scr(id) {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.nav-i').forEach(n => n.classList.remove('active'));
        if(id && id !== 'main') {
            document.getElementById('m-'+id).classList.add('active');
            this['rend_'+id]();
        }
        const idx = {main:0, quests:1, clans:2, pvp:3, shop:4}[id||'main'];
        document.querySelectorAll('.nav-i')[idx].classList.add('active');
    },

    render() {
        document.getElementById('st-en').innerText = `${Math.floor(this.u.en)}/${this.u.mEn}`;
        document.getElementById('st-pwr').innerText = this.u.pwr;
        document.getElementById('st-cigs').innerText = Math.floor(this.u.cigs);
        document.getElementById('st-lvl').innerText = this.u.lvl;
        document.getElementById('f-en').style.width = (this.u.en/this.u.mEn*100)+'%';
        document.getElementById('f-rage').style.width = this.u.rage+'%';
        document.getElementById('f-exp').style.width = (this.u.exp/(this.u.lvl*1000)*100)+'%';
        
        const b = this.bosses[this.u.bIdx];
        document.getElementById('b-name').innerText = b.n;
        document.getElementById('b-hp').innerText = `${Math.ceil(b.hp)} HP`;
        document.getElementById('f-hp').style.width = (b.hp/b.m*100)+'%';
        document.getElementById('clan-display').innerText = this.u.clan ? `–ë–†–ò–ì–ê–î–ê: ${this.u.clan}` : "–ë–ï–ó –ë–†–ò–ì–ê–î–´";
    },

    // –ú–û–î–ê–õ–ö–ò (–û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢)
    rend_quests() {
        const qs = [{n:"–ü–æ–º—ã—Ç—å –ø–æ–ª—ã", e:5, r:100}, {n:"–°—Ç—ã—Ä–∏—Ç—å —Å–∏–≥–∏", e:20, r:600}, {n:"–ë—É–Ω—Ç", e:60, r:3000}];
        document.getElementById('q-list').innerHTML = qs.map(q => `
            <div class="card"><div><b>${q.n}</b><br><small>+${q.r} üö¨</small></div>
            <button class="btn" onclick="core.doQ(${q.e}, ${q.r})">-${q.e}‚ö°</button></div>
        `).join('');
    },

    doQ(e, r) { if(this.u.en >= e) { this.u.en -= e; this.u.cigs += r; this.u.exp += e*2; this.render(); this.rend_quests(); this.save(); } },

    rend_clans() {
        document.getElementById('cl-list').innerHTML = this.clans.map(c => `
            <div class="card"><div><b>${c.n}</b><br><small>–í–∑–Ω–æ—Å: ${c.c} üö¨ | –ë–æ–Ω—É—Å: +${c.b} –∫ —Å–∏–ª–µ</small></div>
            <button class="btn" onclick="core.joinC('${c.n}', ${c.c}, ${c.b})" ${this.u.clan===c.n?'disabled':''}>${this.u.clan===c.n?'–í–°–¢–£–ü–ò–õ':'–í–°–¢–£–ü–ò–¢–¨'}</button></div>
        `).join('');
    },

    joinC(n, c, b) { if(this.u.cigs >= c) { this.u.cigs -= c; this.u.clan = n; this.u.pwr += b; this.render(); this.rend_clans(); this.save(); } },

    rend_pvp() {
        const targets = [{n:"–í–∞—Å—è –õ—ã—Å—ã–π", p:20, r:500}, {n:"–ü–µ—Ç—è –®–∫–∞—Ñ", p:100, r:2000}, {n:"–ñ–µ–∫–∞ –õ—é—Ç—ã–π", p:500, r:10000}];
        document.getElementById('pvp-list').innerHTML = targets.map(t => `
            <div class="card"><div><b>${t.n}</b><br><small>–°–∏–ª–∞: ${t.p}</small></div>
            <button class="btn" onclick="core.fight('${t.n}', ${t.p}, ${t.r})">–ù–ê–ï–•–ê–¢–¨</button></div>
        `).join('');
    },

    fight(n, p, r) {
        if(this.u.en < 20) return tg.showAlert("–ú–∞–ª–æ –Ω—ã—Ä–∫–æ–≤ –¥–ª—è –Ω–∞–µ–∑–¥–∞!");
        this.u.en -= 20;
        if(this.u.pwr > p) { this.u.cigs += r; tg.showAlert(`–ü–û–ë–ï–î–ê! –¢—ã –æ—Ç–∂–∞–ª —É ${n} ${r} üö¨`); }
        else { this.u.cigs = Math.max(0, this.u.cigs - r/2); tg.showAlert(`–¢–´ –ü–†–û–ò–ì–†–ê–õ! ${n} —Ç–µ–±—è –æ–ø—É—Å—Ç–∏–ª –Ω–∞ –ø–∞–ø–∏—Ä–æ—Å—ã.`); }
        this.render(); this.save();
    },

    rend_shop() {
        const ts = [{n:"–ü–µ—Ä—Å—Ç–µ–Ω—å", c:1500, p:50}, {n:"–ö—É–ø–æ–ª–∞", c:20000, p:800}];
        document.getElementById('s-list').innerHTML = ts.map(t => `
            <div class="card"><div><b>${t.n}</b><br><small>+${t.p} ü§ò</small></div>
            <button class="btn" onclick="core.buyT('${t.n}', ${t.c}, ${t.p})" ${this.u.tats.includes(t.n)?'disabled':''}>–ö–£–ü–ò–¢–¨</button></div>
        `).join('');
    },

    buyT(n, c, p) { if(this.u.cigs >= c) { this.u.cigs -= c; this.u.pwr += p; this.u.tats.push(n); this.render(); this.rend_shop(); this.save(); } }
};

window.onload = () => core.init();
</script>
</body>
</html>
